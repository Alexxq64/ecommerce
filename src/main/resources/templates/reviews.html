<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>Отзывы</title>
  <meta charset="UTF-8">
</head>
<body>

<!-- Кнопка назад в каталог -->
<p>
  <a th:href="@{/}">← Вернуться в каталог</a>
</p>

<h1>Отзывы о товаре: <span th:text="${productName}">Название товара</span></h1>

<h2>Все отзывы</h2>

<table>
  <thead>
  <tr>
    <th>Пользователь</th>
    <th>Комментарий</th>
    <th>Дата</th>
    <th>Действия</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="review : ${reviews}">
    <td th:text="${review.username}">Пользователь</td>
    <td th:text="${review.content}">Комментарий</td>
    <td th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy HH:mm')}">Дата</td>
    <td>
      <!-- Кнопка редактировать для админа -->
      <span sec:authorize="hasRole('ADMIN')">
                <a th:href="@{'/reviewsEdit/' + ${review.id} + '?productId=' + ${productId}}">Редактировать</a>
                &nbsp;|&nbsp;
            </span>

      <!-- Кнопка редактировать для автора -->
      <span sec:authorize="isAuthenticated()" th:if="${review.username == #authentication.name}">
                <a th:href="@{'/reviewsEdit/' + ${review.id} + '?productId=' + ${productId}}">Редактировать</a>
                &nbsp;|&nbsp;
            </span>

      <!-- Кнопка удалить (можно также ограничить по ролям, если нужно) -->
      <form th:action="@{'/reviews/delete/' + ${review.id}}" method="post" style="display:inline;">
        <input type="hidden" name="productId" th:value="${productId}" />
        <button type="submit">Удалить</button>
      </form>
    </td>
  </tr>
  <tr th:if="${#lists.isEmpty(reviews)}">
    <td colspan="4">Отзывов пока нет.</td>
  </tr>
  </tbody>
</table>

<hr/>

<!-- Форма добавления отзыва (доступна только аутентифицированным) -->
<div sec:authorize="isAuthenticated()">
  <h2>Добавить отзыв</h2>
  <form th:action="@{'/reviews/product/' + ${productId} + '/add'}" method="post" th:object="${newReview}">
    <textarea th:field="*{content}" placeholder="Комментарий..." required></textarea><br/>
    <button type="submit">Отправить</button>
  </form>
</div>

<!-- Сообщение для неаутентифицированных пользователей -->
<div sec:authorize="!isAuthenticated()">
  <p><a th:href="@{/login}">Войдите</a>, чтобы оставить отзыв.</p>
</div>

</body>
</html>
